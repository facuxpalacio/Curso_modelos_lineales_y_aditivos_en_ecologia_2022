# Modelos mixtos
## Dependencia temporal
```{r crecimiento}
set.seed(101)
tiempo <- seq(1, 20, length = 30)
a <- 20
b <- 5
c <- 0.3
peso <- a - (a - b)*exp(-c*tiempo) + rnorm(n = 30, mean = 0, sd = 0.5)
plot(tiempo, peso)

# GrÃƒÂ¡fico de residuos
m.crec <- lm(log(peso) ~ log(tiempo))
plot(log(tiempo), log(peso))
abline(m.crec, lwd = 2, col = "blue")
plot(log(tiempo), resid(m.crec), xlab = "log(tiempo)", ylab = "Residuos")

# FunciÃƒÂ³n de autocorrelaciÃƒÂ³n
plot(acf(peso))
```

## Dependencia espacial
UbicaciÃƒÂ³n (coordenadas) y concentraciÃƒÂ³n de metales pesados en el rÃ­o Mosa (Europa).
```{r meuse data}
library(sp)
library(gstat)
library(ggplot2)
data(meuse)
coordinates(meuse) = ~x+y
bubble(meuse, "zinc", col = "#00ff0088", main = "zinc concentrations (ppm)")

m.espacial <- lm(zinc ~ x + y, data = meuse)
plot(meuse$x, resid(m.espacial))
abline(a = 0, b = 0, lty = 2)
plot(meuse$y, resid(m.espacial))
abline(a = 0, b = 0, lty = 2)

data(meuse)
meuse$residuos <- resid(m.espacial)
ggplot(meuse, aes(x = x, y = y, col = residuos)) +
  geom_point(size = 4) +
  scale_color_gradient(low = "yellow", high = "red")

# Semivariograma
coordinates(meuse) = ~x+y
zinc.variog <- variogram(zinc ~ 1, meuse)
plot(zinc.variog)
```

## IntroducciÃƒÂ³n a los modelos mixtos
A partir de 8 plantas, se contaron el nÃƒÂºmero de flores en 3 inflorescencias por planta y se midiÃƒÂ³ la longitud de los pedicelos. Analizar la relaciÃƒÂ³n entre la longitud del pedicelo y el nÃƒÂºmero de flores/inflorescencia.
```{r mixtos}
id <- factor(sort(rep(1:8, 3)))
long.pedicelo <- c(1, 1.3, 1.4, 2, 2.2, 2.1, 2.9, 3, 2.8, 3.5, 3.4, 3.7,
                   4.5, 4.7, 4.7, 5.5, 5.7, 6, 7.2, 7.3, 7.5, 8.4, 8.8, 8.6)
nflores <- c(2, 2, 3, 4, 5, 4, 5, 6, 7, 8, 7, 10, 10, 12, 11, 11, 13, 12,
             13, 11, 14, 14, 17, 15)
plantas <- data.frame(id, long.pedicelo, nflores)
plantas

plot(plantas$long.pedicelo, plantas$nflores, pch = 19, cex = 2, 
     xlab = "Longitud del pedicelo", ylab = "NÃƒÂºmero de flores")

# OpciÃƒÂ³n 1: asumimos que las observaciones son independientes
m1 <- lm(nflores ~ long.pedicelo, data = plantas)
summary(m1)

# OpciÃƒÂ³n 2: una media por unidad
xlong.pedicelo <- tapply(long.pedicelo, id, mean)
xnflores <- tapply(nflores, id, mean)
plot(xlong.pedicelo, xnflores, pch = 19, cex = 2)
m2 <- lm(xnflores ~ xlong.pedicelo)
summary(m2)

# OpciÃƒÂ³n 3: incluir el efecto de la unidad
m3 <- lm(nflores ~ long.pedicelo + id, data = plantas)
summary(m3)

# OpciÃƒÂ³n 4: modelo mixto de intercepto aleatorio
library(lme4)
library(lmerTest)
m4 <- lmer(nflores ~ long.pedicelo + (1|id), data = plantas)
summary(m4)
ranef(m4) 
rand(m4) # Significancia de efectos aleatorios

long.pedicelo.new <- seq(min(plantas$long.pedicelo), max(plantas$long.pedicelo), length = 100)
newdata <- expand.grid(long.pedicelo.new, plantas$id)
colnames(newdata) <- c("long.pedicelo", "id")
newdata$predy.fixed <- predict(m4, newdata = newdata, re.form = NA)
newdata$predy.rand <- predict(m4, newdata = newdata, re.form = NULL)

ggplot(data = plantas, aes(x = long.pedicelo, y = nflores, col = id)) +
  geom_point(size = 2) + 
  geom_line(data = newdata, aes(x = long.pedicelo, y = predy.rand)) +
  geom_line(data = newdata, aes(x = long.pedicelo, y = predy.fixed), col = "black", size = 2) + ggtitle("Modelo de intercepto aleatorio") +
  xlab("Longitud del pedicelo") + ylab("Numero de flores") +
  theme_bw()

# OpciÃƒÂ³n 5: modelo mixto de intercepto y pendiente aleatorios
m5 <- lmer(nflores ~ long.pedicelo + (long.pedicelo|id), data = plantas)
summary(m5)
ranef(m5)
rand(m5)

newdata$predy.fixed <- predict(m5, newdata = newdata, re.form = NA)
newdata$predy.rand <- predict(m5, newdata = newdata, re.form = NULL)
ggplot(data = plantas, aes(x = long.pedicelo, y = nflores, col = id)) +
  geom_point(size = 2) + 
  ggtitle("Modelo de intercepto y pendiente aleatorios") +
  geom_line(data = newdata, aes(x = long.pedicelo, y = predy.rand)) +
  geom_line(data = newdata, aes(x = long.pedicelo, y = predy.fixed), col = "black", size = 2) +
  xlab("Longitud del pedicelo") + ylab("Numero de flores") +
  theme_bw()
```

## Un caso especial
```{r simpson}
library(data.table)
library(nlme)
url <- "https://raw.githubusercontent.com/hauselin/rtutorialsite/master/data/simpsonsParadox.csv"
df <- fread(url)
head(df)
plot(df$grades, df$iq)

model.class <- lme(iq ~ grades, random = ~1|class, data = df)
predy.fixed <- predict(model.class, level = 0)
 
ggplot(df, aes(grades, iq, col = class)) + geom_point(size = 2.5) +
ggtitle("Paradoja de Simpson") +
geom_smooth(method = "lm", se = FALSE) +
geom_line(data = data.frame(x = df$grades, y = predy.fixed), aes(x, y), col = "black", size = 3) +
theme_bw()
```

## Modelos lineales generalizados mixtos
Palacio et al. (2014) estudiaron la selecciÃƒÂ³n natural mediada por aves frugÃƒÂ­voras sobre rasgos de los frutos de *Celtis tala* (frutos Celtis 2013.txt), incluyendo el diametro (diam), peso (peso), concentraciÃƒÂ³n de azÃƒÂºcares (az), peso de pulpa (pulpa), peso de semilla (sem) y relaciÃƒÂ³n peso de pulpa/peso de semilla (pulpa.sem). Para esto se midieron 4-10 frutos por ÃƒÂ¡rbol en 24 ÃƒÂ¡rboles y 4 parches de bosque.

#### DiseÃƒÂ±o anidado
```{r glmm}
library(glmmTMB)
library(lme4)
library(MuMIn)
library(sjPlot)
library(equatiomatic)
celtis <- read.delim("C:/RD/frutos Celtis 2013.csv", sep = ";")
table(celtis$planta)
table(celtis$planta, celtis$parche) # Es un diseÃƒÂƒÃ‚Â±o anidado?

lmm.m0 <- lm(sem ~ diam, data = celtis)
lmm.m1 <- glmmTMB(sem ~ diam + (1|planta), family = gaussian, data = celtis)
lmm.m2 <- glmmTMB(sem ~ diam + (1|parche/planta), family = gaussian, data = celtis)

# ComparaciÃƒÂ³n de modelos
AIC(lmm.m0, lmm.m1, lmm.m2)
r.squaredGLMM(lmm.m1)
summary(lmm.m1)

# GrÃƒÂ¡fico
diam.new <- seq(min(celtis$diam, na.rm = TRUE), max(celtis$diam, na.rm = TRUE), length = 5)
newdata <- expand.grid(diam.new, celtis$planta, stringsAsFactors = TRUE)
colnames(newdata) <- c("diam", "planta")
newdata$parche <- substr(newdata$planta, 1, 2)

newdata$predy.fixed <- predict(lmm.m2, newdata = newdata, re.form = NA) # poblacional
newdata$predy.rand1 <- predict(lmm.m2, newdata = newdata, re.form = NULL) # planta
rand2 <- ranef(lmm.m2)$cond$parche
rand2.parche <- rand2[match(newdata$parche, rownames(rand2)), 1]
a <- fixef(lmm.m2)$cond[1]
b <- fixef(lmm.m2)$cond[2]
newdata$predy.rand2 <- a + b*newdata$diam + rand2.parche

# Efecto planta
ggplot(data = celtis, aes(x = diam, y = sem, col = planta)) +
  geom_point(size = 2) + 
  ggtitle("Modelo con factores aleatorios anidados") +
  geom_line(data = newdata, aes(x = diam, y = predy.rand1)) +
  geom_line(data = newdata, aes(x = diam, y = predy.fixed), col = "black", size = 2) +
  xlab("Diametro del fruto (mm)") + ylab("Masa de semilla (g)")

# Efecto parche
ggplot(data = celtis, aes(x = diam, y = sem, col = parche)) +
  geom_point(size = 2) + 
  ggtitle("Modelo con factores aleatorios anidados") +
  geom_line(data = newdata, aes(x = diam, y = predy.rand2, col = parche)) +
  geom_line(data = newdata, aes(x = diam, y = predy.fixed), col = "black", size = 2) +
  xlab("Diametro del fruto (mm)") + ylab("Masa de semilla (g)")

# Tabla resumen
tab_model(lmm.m2)

# Ecuaciones del modelo
lmm.m1 <- lmer(sem ~ diam + (1|planta), data = celtis)
lmm.m2 <- lmer(sem ~ diam + (1|parche/planta), data = celtis)
extract_eq(lmm.m1)
extract_eq(lmm.m2)
```

#### DiseÃƒÂƒÃ‚Â±o cruzado
```{r cruzado}
data(Penicillin)
str(Penicillin)
summary(Penicillin)
table(Penicillin$plate, Penicillin$sample) # Es un diseÃƒÂƒÃ‚Â±o cruzado?

lmm.pen <- lmer(diameter ~ 1 + (1|plate) + (1|sample), data = Penicillin)
summary(lmm.pen)

# Tabla resumen
tab_model(lmm.pen)

# GrÃƒÂ¡fico de efectos aleatorios
plot_model(lmm.pen, type = "re")
```

## Modelos mixtos con estructura espacial
Palacio et al. (2017) estudiaron el consumo de frutos por aves en $Psychotria  carthagenensis$ en un bosque secundario pedemontano de las Yungas (Psychotria_El_Corte_2012.txt). Se quiere analizar si el peso del fruto (*x.peso*) se relaciona con el número de infrutescencias (*n.infrut*).
```{r glmm espacial}
library(glmmTMB)
psycho <- read.table("C:/RD/Psychotria_El_Corte_2012.txt", header = TRUE)
hist(psycho$x.diam, xlab = "Diámetro promedio del fruto", ylab = "Frecuencia")
plot(psycho$x, psycho$y, pch = 19)

psycho$pos <- numFactor(psycho$x, psycho$y)
psycho$group <- factor(rep(1, nrow(psycho)))
lm.no_espacial <- lm(x.diam ~ n.infrut, data = psycho)

glmm.espacial <- glmmTMB(x.diam ~ n.infrut + exp(pos + 0|group), family = gaussian, data = psycho)
summary(glmm.espacial)
AIC(lm.no_espacial, glmm.espacial)
```

## Modelos aditivos generalizados mixtos
Price et al. (2016) estudiaron la abundancia de salamandras de cursos de agua (*count*) en 23 sitios (*Site*) muestreados 4 veces (*Sample*), junto con distintas covariables (estandarizadas), como el uso de suelo (*mined*), temperatura del agua (*Wtemp*). Para más información sobre los metadatos, puede acceder a https://datadryad.org/stash/dataset/doi:10.5061/dryad.5m8f6
```{r gamms}
library(glmmTMB)
data(Salamanders)
hist(Salamanders$count)
pairs(Salamanders[, c(3, 5:7, 9)])
cor(Salamanders[, c(3, 5:7, 8)])

gamm.pois <- gamm(count ~ s(DOP) + S(DOY) + s(Wtemp), random = list(site = ~1), family = poisson, data = Salamanders)

gamm.bn <- gamm(count ~ s(DOP) + S(DOY) + s(Wtemp), family = nb, random = list(site = ~1), data = Salamanders)

AIC(gamm.pois$lme, gamm.bn$lme)

summary(gamm.pois$gam)
plot(gamm.pois$gam)

summary(gamm.nb$gam)
plot(gamm.nb$gam)



```



## Actividades

#### Ejercicio 5.1
Palacio et al. (2014) realizaron conteos de 44 especies de aves a lo largo de un aÃƒÂ±o en 10 puntos de muestreos (**id**) localizados en un bosque de ligustro y arbustales circundantes (**habitat.type**). El set de datos corresponde a **abundancia_aves.txt**.

- Analice los factores que se relacionan con la abundancia total de individuos y con las siguientes dos especies: Tordo mÃƒÂºsico (**agebad**) y Benteveo (**pitsul**).

- Identifique los efectos fijos y aleatorios incluidos en cada modelo.

- SegÃƒÂºn el problema de estudio y el modelo especificado Ã‚Â¿A quÃƒÂ© tipo de diseÃƒÂ±o corresponde?

- En base a los resultados obtenidos ¿Tiene sentido incluir efectos aleatorios? Justifique.

- ¿Puede hipotetizar algo sobre la distribuciones de probabilidad utilizada para cada especie y para la abundancia total?


### Ejercicio 5.2
Johnson & Manoukis (2021) analizaron la relación entre el número de capturas de la Broca del Café (*Hypothenemus hampei*, Curculionidae) y distintas variables climáticas en cafetales de Hawai (https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0257861). El archivo corresponde a *Weather_CBB_flight.xls*. Los metadatos están en el archivo *README_JohnsonManoukisPLoSONE2021.xls*.

- Ajuste un modelo que relacione el número de capturas con variables climáticas. Para esto, construya un modelo saturado y compare primero diferentes estructuras de efectos aleatorios. Luego, realice una selección de modelos considerando diferentes efectos fijos.

