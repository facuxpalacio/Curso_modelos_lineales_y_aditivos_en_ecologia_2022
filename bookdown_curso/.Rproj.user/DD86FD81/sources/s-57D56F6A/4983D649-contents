# Modelos lineales generalizados
### PRESENCIA-AUSENCIA
Cabral et al. (2007) estudiaron la distribuciÃ³n de platijas (*Solea solea*) en el estuario Tagus, Portugal. Se desea saber quÃ© factores estÃ¡n relacionados con la presencia esta especie.
```{r explo1}
# Analisis exploratorio
datos <- read.table("C:/RD/Solea.txt", header = TRUE)
str(datos)
hist(datos$Solea_solea)
table(datos$Solea_solea)
pairs(datos[, 4:12])
round(cor(datos[, 4:12]), 2)
```

\

#### GLM binomial
```{r glm binomial}
m.bin <- glm(Solea_solea ~ temperature + transparency + salinity, family = binomial, data = datos)
summary(m.bin)
```

\

### Bondad del ajuste
```{r bondad binomial}
summary(m.bin)
1 - (m.bin$dev/m.bin$null) # Pseudo-R2
library(performance)
r2_tjur(m.bin) # Coeficiente de determinacion de Tjur
```

\

### Grafico del  modelo
```{r grafico binomial}
library(visreg)
visreg(fit = m.bin, xvar = "salinity", scale = "response", ylim = c(0, 1), 
       xlab = "Salinidad", ylab = "Probabilidad de presencia") 
points(datos$salinity, datos$Solea_solea)
```

\

### Interpretacion de los coeficientes
```{r interpretacion coef}
exp(m.bin$coeff[2]) # Razon de odds
```
Por unidad de salinidad, la relaciÃ³n $\frac{P(presencia)}{P(ausencia)}$ (odd) disminuye en 0.90 unidades

\

### Validacion
```{r validacion glm binomial}
plot(m.bin)
library(DHARMa)
plot(simulateResiduals(fittedModel = m.bin))
```

\

### Ecuacion
```{r ecuacion glm binomial}
library(equatiomatic)
extract_eq(m.bin, use_coefs = TRUE, fix_signs = TRUE)
```

\

### Capacidad predictiva
```{r matriz confusion}
# Matriz de confusion
obs <- datos$Solea_solea
pred <- ifelse(predict(m.bin, type = "response")>0.5, 1, 0)
matriz.conf <- table(obs, pred) 
matriz.conf
# Porcentajes de clasificacion
matriz.conf/rowSums(matriz.conf)
```

\

#### CONTEOS
Gotelli & Ellison (2002) analizaron los determinantes biogeogrÃ¡ficos de la riqueza de hormigas (Srich) a escala regional (hormigas.txt). Para esto se describiÃ³ el tipo de hÃ¡bitat (Habitat), la latitud (Latitude) y la altitud (Elevation).

```{r explo2}
# Analisis exploratorio
h <- read.table("C:/RD/hormigas.txt", header = T) 
str(h)
h$Habitat <- as.factor(h$Habitat)
pairs(h[, 2:5])
round(cor(h[, c(2, 4:5)]), 2)
plot(table(h$Srich), xlab = "Numero de especies", ylab = "Frecuencia")
hist(h$Srich, xlab = "Numero de especies", ylab = "Frecuencia relativa", main = "", freq = FALSE)
# Ajuste de distribucion a los datos
sim.pois <- dpois(x = 0:max(h$Srich), lambda = mean(h$Srich))
lines(x = 0:max(h$Srich), y = sim.pois, col = "blue", lwd = 2, type = "b")
var(h$Srich)/mean(h$Srich)
```

\

### GLM Poisson
```{r glm poisson}
m.pois <- glm(Srich ~ Latitude + Elevation + Habitat, family = poisson, data = h)
summary(m.pois)
```

\

### GLM quasi-Poisson
```{r glm quasipoisson}
m.qpois <- glm(Srich ~ Latitude + Elevation + Habitat, family = quasipoisson, data = h)
summary(m.qpois)

# ParÃ¡metro de dispersiÃ³n
resid <- residuals(m.qpois, type = "pearson")
nparam <- length(m.qpois$coeff)
ndatos <- nrow(h)
disp.param <- sum(resid^2)/(ndatos - nparam)
disp.param

m.qpois.null <- glm(Srich ~ 1, family = quasipoisson, data = h)
summary(m.qpois.null)

library(DHARMa)
testDispersion(m.pois)
```

\

### Validacion
```{r validacion glm poisson}
residP <- resid(m.qpois, type = "pearson")  # residuos de Pearson 
residD <- resid(m.qpois, type = "deviance") # residuos de devianza 
pred <- predict(m.qpois, type = "response") # valores predichos 
plot(pred, residP) 
plot(pred, residD)
plot(simulateResiduals(fittedModel = m.pois))
```

\

### Bondad del ajuste
```{r bondad glm poisson}
1 - (m.qpois$dev/m.qpois$null) # Pseudo-R2
```

\

### Ecuacion
```{r ecuacion glm poisson}
library(equatiomatic)
extract_eq(m.qpois, use_coefs = TRUE, fix_signs = TRUE)
```

\

### Graficos
```{r grafico glm poisson}
library(visreg)
visreg(fit = m.qpois, xvar = "Latitude", by = "Habitat", overlay = TRUE, 
       scale = "response", xlab = "Latitud (Âº)", ylab = "Numero de especies",
       type = "conditional", cond = list(Latitude = mean(h$Latitude), Elevation = mean(h$Elevation))) 
bg <- h[h$Habitat == "Bog", ] 
ft <- h[h$Habitat == "Forest", ] 
points(bg$Latitude, bg$Srich, pch=19, col = "red") 
points(ft$Latitude, ft$Srich, pch=19, col = "blue")
```

\

### GLM binomial negativo
Leong et al. (2014) estudiaron el efecto del paisaje (urbano, agrÃ­cola y natural) sobre el nÃºmero de interacciones de polinizadores nativos en $Centaurea solstitialis$ (Asteraceae). Se quiere evaluar si existen diferencias en el nÃºmero de interacciones (total) entre los 3 tipos de ambientes (type) teniendo en 
cuenta la temperatura (temp) y la velocidad del viento (wind). 

```{r explo3}
# Analisis exploratorio
pol <- read.table("C:/RD/bees_data.txt", header = T) 
str(pol)
pol$habitat <- factor(pol$type, levels = c("n", "a", "u"))
pairs(pol[, c("habitat", "temp", "wind", "total")])
boxplot(pol$total ~ pol$habitat)
cor(pol$temp, pol$wind)
hist(pol$total, xlab = "Numero de interacciones", ylab = "Frecuencia relativa", main = "", freq = FALSE, ylim = c(0, 0.05))
# Ajuste de distribucion a los datos
sim.pois <- dpois(x = 0:max(pol$total), lambda = mean(pol$total))
lines(x = 0:max(pol$total), y = sim.pois, col = "blue", lwd = 2, type = "b")
var(pol$total)/mean(pol$total)
```

\

### Chequear sobredispersion
```{r sobredispersion}
mqpoi.pol <- glm(total ~ habitat + temp + wind, family = quasipoisson, data = pol) 
summary(mqpoi.pol)
library(DHARMa)
mpoi.pol <- glm(total ~ habitat + temp + wind, family = poisson, data = pol)
testDispersion(mpoi.pol)
```

\

### Validacion del modelo quasipoisson
```{r validacion glm quasipoisson}
plot(simulateResiduals(fittedModel = mpoi.pol))
```

\

### Modelo binomial negativo
```{r glm BN}
library(MASS)
mbn.pol <- glm.nb(total ~ habitat + temp + wind, data = pol) 
summary(mbn.pol)
```

\

### Validacion del modelo binomial negativo
```{r validacion glm BN}
plot(simulateResiduals(fittedModel = mbn.pol))
```

\

### Bondad del ajuste
```{r bondad BN}
1 - (mbn.pol$dev/mbn.pol$null) # Pseudo-R2
```

\

### Ecuacion
```{r ecuacion glm BN}
extract_eq(mbn.pol, use_coefs = TRUE, fix_signs = TRUE)
```

\

### Comparaciones multiples
```{r comparaciones}
library(multcomp) 
comp <- glht(mbn.pol, mcp(habitat = "Tukey")) 
summary(comp) 
```

\

### Incluyendo un offset
```{r offset}
mbn.pol.off <- glm.nb(total ~ habitat + temp + wind + offset(log(min)), data = pol)
summary(mbn.pol.off)
```

\

### Graficos
```{r grafico glm BN}
layout(matrix(1:2, 1, 2))
visreg(fit = mbn.pol, xvar = "habitat", scale = "response", cond = list(temp = mean(pol$temp), wind = mean(pol$wind)), xlab = "Habitat", ylab = "Numero de visitas", main = "GLM binomial negativo")
visreg(fit = mbn.pol.off, xvar = "habitat", scale = "response", cond = list(temp = mean(pol$temp), wind = mean(pol$wind), min = 1), xlab = "Habitat", ylab = "Tasa de visitas (ind/min)", main = "GLM binomial negativo con offset")
layout(1)
```

\

## Modelo lineal general
Palacio et al. (2014) estudiaron la seleccion natural mediada por aves frugivoras sobre rasgos de los frutos de *Celtis tala* (frutos Celtis 2013.txt), incluyendo el diametro (diam), peso (peso), concentracion de azucares (az), peso de pulpa (pulpa), peso de semilla (sem) y relacion peso de pulpa/peso de semilla (pulpa.sem). Analizar quÃ© factores explican el tamanio del fruto. 
```{r lm}
celtis <- read.delim("C:/RD/frutos Celtis 2013.csv", sep = ";")
str(celtis)
pairs(celtis[, 3:7])
round(cor(celtis[, 4:7], use = "complete.obs"), 2)
hist(celtis$diam, xlab = "Diametro (mm)", ylab = "Frecuencia", main = "")
mlg <- glm(diam ~ az + sem, family = gaussian, data = celtis)
summary(mlg)
```

\

## GLM Gamma
Allen et al. (2015) analizaron el efecto de grandes carnivoros ($Ursus americanus$ y $Puma concolor$) sobre la actividad de carronieros. Registraron la duracion media del evento de alimentacion (duration) por carronieros en sitios con cadaveres producto de pumas y sitios control donde se colocaron cadaveres colectados en la ruta (trat).
```{r glm gamma}
# Graficos exploratorios 
datos <- read.table("C:/RD/puma.txt", header = TRUE)
datos$trat <- as.factor(datos$trat)
P <- subset(datos, trat == "Puma_Kill") 
C <- subset(datos, trat == "Control") 
layout(matrix(1:2, 1, 2)) 
hist(P$duration) 
hist(C$duration) 
layout(1) 
boxplot(datos$duration ~ datos$trat) 
 
# GLM Gamma 
m.Gamma <- glm(duration ~ trat, family = Gamma, data = datos) 
summary(m.Gamma)
 
# Comparaciones multiples 
library(multcomp)
comp <- glht(m.Gamma, mcp(trat = "Tukey")) 
summary(comp)
```

\

## Modelos truncados en cero
Santos et al. (2011) estudiaron la probabilidad de persistencia de las carcasas de animales muertos en ruta (Snakes.txt). La variable respuesta es la cantidad de dias que perduraban las carcasas sin ser removidas (N_days). Las variables explicatorias son el tamanio de cada especie (Size_cm), la proporcion de dias con lluvia (PDayRain), las precipitaciones totales (Tot_Rain), la temperatura diaria promedio (Temp_avg), la identidad de la ruta que representa la intesidad del trafico (Road; EN114 tiene alto transito, EN4 tiene trafico medio, y EN370_EN114_4 tiene bajo trafico), la ubicaciÃ³n en la ruta (Road_Loc; L = asfalto, V = borde), la estacion (Season), y la especie (Species).

```{r explo6}
# Analisis exploratorio
serp <- read.table("C:/RD/Snakes.txt", header = T) 
str(serp)
plot(table(serp$N_days))
mean(serp$N_days)
pairs(serp[, c("PDayRain", "Tot_Rain", "Temp_avg")])
round(cor(serp[, c("PDayRain", "Tot_Rain", "Temp_avg")]), 2)
boxplot(serp$PDayRain ~ serp$Season)
boxplot(serp$Tot_Rain ~ serp$Season)
boxplot(serp$Temp_avg ~ serp$Season)
```
\

### GLM Poisson

```{r glm poisson 2}
m.pois <- glm(N_days ~ Size_cm + PDayRain + Tot_Rain + Road + Size_cm + Road_Loc + Size_cm:PDayRain, family = poisson, data = serp)
summary(m.pois)
```